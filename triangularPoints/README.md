# TriangularPoints by 叶培楚

### 代码内容介绍
通过TriangularPoints类将特征提取的内容封装起来。

**三角化主要包括**
1. ORB-SLAM中的三角化方法;
2. VINS-MONO中的三角化方法;
3. OpenCV自带的TriangulatePoints三角化方法;
4. 根据理论推导出来的三角化方法。
总而言之，这四个方法，没有半毛钱区别。

**代码流程**
1. 读取两帧图像；
2. 对两帧图像分别提取特征点；
3. 特征匹配；
4. 利用经验值优化匹配结果并显示匹配；
5. 计算相对运动（本质矩阵或基础矩阵）；
6. 三角化点；
7. 归一化所有点；
8. 输出深度值。


### 三角化原理

> **三角化的目的：**
&ensp; &ensp; 在视觉SLAM当中，所用的传感器大体可以分为三种，单目，双目和RGB-D相机。（当然，像事件相机和鱼眼相机那些我们暂时不考虑）
&ensp; &ensp; **RGB-D相机**可以同时获取环境的彩色图像和深度图像，直接知道环境的距离深度信息。在室内的小环境中，RGB-D可以非常方便地帮助我们节省非常多的计算资源。但是遗憾的是，RGB-D相机受光照的影响较大，很难应用于室外环境；
&ensp; &ensp; **双目相机**的好处是可以通过固定基线的双目图像计算环境的深度信息。不同于RGB-D相机，双目图像可探测的距离取决于基线的长度以及分辨率，且对于光照变化的敏感度也稍微低一些。缺陷是需要耗费较多的计算资源来计算环境的深度信息。细想一下，一帧图像如果有三十万个像素点，那么每一个像素点需要在右帧极线上搜索匹配点，并对其进行三角化，才能得到最终的深度值，那得是多恐怖的事情！当然，视觉SLAM不可能用这么坑爹的方法，不然匹配时间就太长了。通常我们会选择一些特征点来代表这个图像，对特征点进行三角化来计算深度值是更加合理的方法。值得注意的是，本文所说的三角化和静态双目的三角化不太一样。静态双目的三角化是通过基线baseline和焦距以及计算出来的视差值来计算得到的。即z = bf / d。另外，现在很多相机厂商都很努力地将双目恢复深度的计算集成到FPGA中，利用硬件加速来计算深度值，这非常值得期待;
&ensp; &ensp; **单目相机**的好处是只需要一个相机，成本较低，操作也比较简单。遗憾的是，正因为只有一个相机，缺少深度值，因此就丢失了绝对尺度信息。这也是本文着重介绍的方法，利用相邻帧或者有匹配点的两个图像，来估算空间点的深度值。但是这个深度值与真实空间中相差一个尺度因子。
&ensp; &ensp; *可以看到，在上述的描述中，单目相机如果想要恢复空间点的深度值，绝对离不开三角化操作。三角化的目的就是通过帧间数据关联，利用约束条件恢复空间信息，从而实现三维重建的目的。*

> **三角化原理：**
&ensp; &ensp; **已知条件：** 两帧图像 $I_{1}$ 和 $I_{2}$ 中有多组特征匹配点，假设其中任意一组特征点对为 $f_{1}$ 和 $f_{2}$，对应的深度值分别为 $z_{1}$ 和 $z_{2}$，其构建了一个空间点 $p_{w}$。相机内参数为 $K$，由于我们采集的两帧图像为同一相机采集的，因此两帧图像的内参数相同。图像 $I_{1}$ 的外参变换 $T_{1w}$ 表示从世界坐标系变换到图像 $I_{1}$ 坐标系中，同理有 $T_{2w}$。
&ensp; &ensp; **约束条件**：已知相机的投影投影方程如下：
$$z_{1}f_{1} = KT_{1w}p_{w}$$
其中，$f_{1} = \begin{bmatrix}
    u_{1} \\
    v_{1} \\
    1
\end{bmatrix}$，$T_{1w} = \begin{bmatrix}
    R_{1w} & t_{1w} \\
    0^T & 1 
\end{bmatrix}$，$K = \begin{bmatrix}
    f_{x} & 0 & c_{x} & 0 \\
    0 & f_{y} & c_{y} & 0 \\
    0 & 0 & 1 & 0 
\end{bmatrix}$，$p_{w} = \begin{bmatrix}
    x_{w} \\
    y_{w} \\
    z_{w} \\
    1 
\end{bmatrix}$
通过令投影矩阵 $P = KT_{1w}$，则有 $z_{1}f_{1} = Pp_{w}$，通过两边叉乘 $f_{1}$，则有：
$$z_{1}f_{1} \times f_{1} = 0 = f_{1} \times Pp_{w}$$
其中，$f_{1}\times = \begin{bmatrix}
    0 & -1 & v_{1} \\
    1 & 0 & -u_{1} \\
    -v_{1} & u_{1} & 0 
\end{bmatrix}$，令$P = \begin{bmatrix}
    P_{1} \\
    P_{2} \\
    P_{3}
\end{bmatrix}$，可以构造矩阵：
$$H_{1} = \begin{bmatrix}
    v_{1}P_{3} - P2 \\
    u_{1}P_{3} - P1 \\
    u_{1}P_{2} - v_{1}P1 
\end{bmatrix}$$
同理，可以得到 $H_{2}$，因此我们可以构建最小二乘优化函数 $min(Hp_{w})$，其中 $H = \begin{bmatrix}
    H_{1} \\
    H_{2} \\
\end{bmatrix}$。通过对其进行SVD分解，$H$ 的最小奇异值对应的解即为使得目标函数取得最小值的解。该解为 $V$ 矩阵的最后一列。解法可以参考我的另一篇博文——[ORBSLAM特征点的三角化](https://www.cnblogs.com/yepeichu/p/10792899.html),这篇博文只是为了回顾一下三角化的知识点。欢迎参考。
对应本文的代码已上传github，对应[TriangularPoints](https://github.com/yepeichu123/slam_module/tree/master/triangularPoints).