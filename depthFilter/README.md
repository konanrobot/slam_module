# DepthFilter by 叶培楚

### 程序介绍

**程序流程**

1. 读取图像；
2. 提取图像特征点；
3. 特征匹配；
4. 计算相对姿态；
5. 三角化空间点；
6. 计算深度不确定性；
7. 记录当前深度值和不确定性记为期望值和方差；
8. 与其余图像重复上述步骤；
9. 将第七、第八步骤得到的两个期望值和两个方差进行高斯融合；
10. 更新深度值及不确定性；
11. 输出深度值和不确定性。


### 深度滤波

**1. 高斯假设**

&ensp; &ensp; 在本文中，主要介绍如何进行深度滤波。本文假设三角化后的点是满足高斯分布假设的，因此每一个点都可以用期望和方差两个参数来描述其概率分布模型。

**2 三角化的空间点**

&ensp; &ensp; 通过对图像中的特征点进行特征匹配，并计算相对位姿，可以利用相邻帧约束关系三角化出空间点。这个空间点是可以有所选择的，比如我们提供的投影矩阵 $P_{1}$ 和 $P_{2}$，如果该投影矩阵表示的是从世界坐标系到关键帧 $K_{1}$ 和 $K_{2}$ 坐标系的相对变换，则我们恢复出来的空间点即为世界坐标系下的空间点。若我们提供的投影矩阵是邻帧间的相对变换，则可以得到参考帧或者当前帧下的深度信息。具体可以从三角化的公式推导出来。

**3. 高斯斯融合**

&ensp; &ensp; 通常情况下，两个高斯模型进行融合，可以得到一个期望值和方差都介于二者之间的高斯模型。如[高斯分布的乘积](https://blog.csdn.net/u012836279/article/details/80036417)这篇文章提供的描述一样。

&ensp; &ensp; 为了更加方便的进行代码的实现，笔者放弃了从NCC极线搜索匹配开始，到最后三角化的一些纯基于像素的操作。而是采用基于特征点的方法进行特征匹配和运动估计，这样可以使得我们的代码不用那么复杂。事实上，在实际操作中，我们一般也都是这么操作的，除非是使用直接法。我们根据[三角化---深度滤波器---单目稠密重建（高翔slam---十三讲）](https://www.cnblogs.com/Jessica-jie/p/7730731.html)这篇文章提供的思路，对三角化后的点进行深度滤波，更新其深度值。值得注意的是，我们需要同一个点在多次不同的三角化中得到的深度值和不确定性，对同一个点进行深度滤波更新。因此我们需要跟踪这些特征点，在实际的SLAM系统当中，这些点我们称为landmark并记录为地图点。地图点的更新便是跟随着不断的三角化和深度滤波而变化的，当然更重要的还是Bundle Adjustment。为了更加直观地了解高斯模型间的融合，笔者参考了[直观理解高斯函数相乘](https://blog.csdn.net/yangziluomu/article/details/55049924)这篇文章。

**4. SVO深度滤波方法**

&ensp; &ensp; 从本文的代码中可以发现，实际上我们对所有的点都一视同仁，统一进行深度滤波，而并不区分是外点还是内点。这样的操作是不理想的，因为我们可能由于三角化出来错误的点，我们仍然对其进行滤波，而这样对于系统的稳定是非常不利的。因此，在SVO中，通过除了引入高斯分布来描述点的深度不确定性，还引入Beta分布来描述外点。具体是在不断的滤波过程中，更新Beta分布的参数，并对新的深度值进行加权，通过对权值的不断调整和更新，可以明显地滤除外点，并融合新的深度值和不确定性。这在[SVO框架总结](https://blog.csdn.net/MAX_Hope/article/details/89387387)中便有详细介绍。

&ensp; &ensp; 在完成上述操作之前，我们需要进行特征点（像素块）间的匹配，这一部分是通过极线搜索进行实现的。匹配的方法大体都是通过最小化像素块间的光度误差，取匹配分数最高的为最优匹配即可。这里值得一提的是，同一个物体，由于在不同的方向拍摄，会导致其发生某种程度的仿射变换，而像素块本身不具备旋转不变性。因此SVO通过利用[三点法](https://blog.csdn.net/augusdi/article/details/14150747)和[OpenCV实现仿射变换--通过三个点进行变换](https://blog.csdn.net/u013713010/article/details/46118743)计算仿射矩阵，将参考帧中的像素块通过仿射矩阵映射到当前帧中，在进行极线搜索时，便是在当前帧中计算过仿射变化的像素块进行相似度度量。这样操作的目的，是为了使像素块匹配具备一定的旋转不变性，提高极线搜索匹配的准确性。

#### 参考文献
1. [高斯分布的乘积](https://blog.csdn.net/u012836279/article/details/80036417)
2. [三角化---深度滤波器---单目稠密重建（高翔slam---十三讲）](https://www.cnblogs.com/Jessica-jie/p/7730731.html)
3. [直观理解高斯函数相乘](https://blog.csdn.net/yangziluomu/article/details/55049924)
4. [SVO框架总结](https://blog.csdn.net/MAX_Hope/article/details/89387387)
5. [三点法](https://blog.csdn.net/augusdi/article/details/14150747)
6. [OpenCV实现仿射变换--通过三个点进行变换](https://blog.csdn.net/u013713010/article/details/46118743)
7. [SVO极线搜索匹配](https://www.jianshu.com/p/ac050d315d12)
8. [SVO深度解析(三)之深度滤波(建图部分)](https://www.cnblogs.com/dreamCll/p/7214326.html)